/**
 * Core Philosophy:
 * This ruleset uses a "user-centric" security model. Authenticated users are granted
 * full control over their own data within the `/users/{userId}` path, but have no
 * access to other users' data. Public collections are read-only for everyone.
 *
 * Data Structure:
 * - /users/{userId}: Private data for each user, identified by their Firebase Auth UID.
 *   - /users/{userId}/dailyLogs/{logId}: Sub-collection for user-specific daily meal logs.
 * - /articles, /food_items, /question_answers: Public, read-only collections.
 *
 * Key Security Decisions:
 * - Ownership-Based Writes: Users can only write (`create`, `update`, `delete`) to
 *   documents where the `{userId}` in the path matches their own `request.auth.uid`.
 *   This is the cornerstone of the security model, ensuring data privacy.
 * - Public Read-Only Content: Informational collections are publicly readable but
 *   client-side writes are strictly forbidden to maintain data integrity. All content
 *   is managed by trusted backend processes.
 *
 * A Note on the 'auth/configuration-not-found' Error:
 * The error you are experiencing is related to Firebase Authentication setup, not
 * Firestore Security Rules. It means the "Email/Password" sign-in provider has not
 * been enabled in your Firebase project console. Please go to the Firebase Console ->
 * Authentication -> Sign-in method tab and enable the "Email/Password" provider.
 * These rules are designed to work correctly once your authentication is configured.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Allows a user to read and write their own profile document.
     *   They cannot see or edit other users' profiles.
     * @path /users/{userId}
     * @allow A user updates their own BMI: (update) /users/my-uid
     * @deny A user tries to read another user's profile: (get) /users/another-uid
     * @principle Enforces data privacy by restricting access to the data owner.
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      /**
       * @description Allows a user to manage their own daily meal logs.
       * @path /users/{userId}/dailyLogs/{logId}
       * @allow A user creates a new meal log for today: (create) /users/my-uid/dailyLogs/2024-07-29
       * @deny A user tries to delete another user's meal log: (delete) /users/another-uid/dailyLogs/2024-07-29
       * @principle Extends data ownership to sub-collections.
       */
      match /dailyLogs/{logId} {
        allow read, write: if isOwner(userId);
      }
    }


    /**
     * @description Allows any user, signed-in or anonymous, to read articles.
     *   All write operations are disabled to protect content integrity.
     * @path /articles/{articleId}
     * @allow A logged-out user reads an article: (get) /articles/healthy-eating-guide
     * @deny Any user tries to create a new article: (create) /articles/new-article-draft
     * @principle Provides public, read-only access to informational content. Data is managed by backend processes, not clients.
     */
    match /articles/{articleId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows any user, signed-in or anonymous, to read food item data.
     *   All write operations are disabled.
     * @path /food_items/{foodItemId}
     * @allow An anonymous user lists all available food items: (list) /food_items
     * @deny A signed-in user tries to delete a food item: (delete) /food_items/apple-data
     * @principle Provides public, read-only access to a shared dataset. Data is managed by backend processes, not clients.
     */
    match /food_items/{foodItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows any user, signed-in or anonymous, to read the Q&A knowledge base.
     *   All write operations are disabled.
     * @path /question_answers/{questionAnswerId}
     * @allow Any user reads a specific Q&A pair: (get) /question_answers/what-is-listeria
     * @deny Any user tries to update an existing answer: (update) /question_answers/what-is-listeria
     * @principle Provides public, read-only access to a shared knowledge base. Data is managed by backend processes, not clients.
     */
    match /question_answers/{questionAnswerId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
